name: Auto Buildï¼ˆè‡ªåŠ¨æ„å»ºï¼‰

permissions:
  contents: write

on:
  push:
    branches: [main, master]  # Push æ—¶è§¦å‘
  pull_request:              # PR æ—¶è§¦å‘
  workflow_dispatch:         # æ‰‹åŠ¨è§¦å‘

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'jetbrains'  # ä½¿ç”¨ JetBrains Runtimeï¼ˆJBRï¼‰ï¼Œä¸º Swing åº”ç”¨ä¼˜åŒ–
  JLINK_MODULES: 'java.base,java.desktop,java.logging,jdk.unsupported,java.naming,java.net.http,java.prefs,java.sql,java.security.sasl,java.security.jgss,jdk.crypto.ec,java.management,java.management.rmi,jdk.crypto.cryptoki'
  # é€šç”¨ Java é€‰é¡¹ï¼ˆæ‰€æœ‰å¹³å°å…±äº«ï¼‰
  JAVA_OPTIONS_COMMON: '-Xms512m|-Xmx1g|-XX:MaxMetaspaceSize=256m|-XX:MetaspaceSize=128m|-XX:MaxDirectMemorySize=256m|-XX:+UseG1GC|-XX:MaxGCPauseMillis=200|-XX:InitiatingHeapOccupancyPercent=45|-XX:+UseStringDeduplication|-XX:+HeapDumpOnOutOfMemoryError|-XX:HeapDumpPath=./dumps|-Dfile.encoding=UTF-8|-Dswing.aatext=true|-Djava.net.preferIPv4Stack=true|-Dhttp.keepAlive=true'
  # Windows ç‰¹å®šé€‰é¡¹
  JAVA_OPTIONS_WINDOWS: '-Djavax.accessibility.assistive_technologies='
  # macOS ç‰¹å®šé€‰é¡¹
  JAVA_OPTIONS_MACOS: '-Dsun.java2d.metal=true|-Dapple.awt.application.appearance=system|--add-opens java.desktop/java.awt=ALL-UNNAMED|--add-opens java.desktop/sun.lwawt=ALL-UNNAMED|--add-opens java.desktop/sun.lwawt.macosx=ALL-UNNAMED|--add-exports java.desktop/com.apple.eawt=ALL-UNNAMED'
  # Linux ç‰¹å®šé€‰é¡¹
  JAVA_OPTIONS_LINUX: '-Dawt.useSystemAAFontSettings=on|--add-opens=java.desktop/sun.awt.X11=ALL-UNNAMED'

jobs:
  # æå–ç‰ˆæœ¬å·ï¼Œä¾›æ‰€æœ‰ job å¤ç”¨
  get-version:
    name: Get Versionï¼ˆè·å–ç‰ˆæœ¬å·ï¼‰
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'
          check-latest: false  # ç¦ç”¨æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬ï¼Œé¿å… GitHub API é€Ÿç‡é™åˆ¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ token æé«˜ API é€Ÿç‡é™åˆ¶

      - name: Extract versionï¼ˆæå–ç‰ˆæœ¬å·ï¼‰
        id: extract_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # æ„å»º Fat JARï¼ˆè·¨å¹³å°ï¼‰ï¼Œä¾›æ‰€æœ‰å¹³å°å¤ç”¨
  build-jar-artifact:
    name: Build Fat JARï¼ˆæ„å»ºè·¨å¹³å° JARï¼‰
    runs-on: ubuntu-latest
    needs: [ get-version ]
    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'
          check-latest: false  # ç¦ç”¨æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬ï¼Œé¿å… GitHub API é€Ÿç‡é™åˆ¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ token æé«˜ API é€Ÿç‡é™åˆ¶

      - name: Build with Mavenï¼ˆä½¿ç”¨ Maven æ„å»º Fat JARï¼‰
        run: mvn -B clean package -DskipTests

      - name: Upload JAR for reuseï¼ˆä¸Šä¼  JAR ä¾›å…¶ä»– job å¤ç”¨ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/easy-postman-${{ needs.get-version.outputs.version }}.jar
          retention-days: 1




  build-windows-portable:
    name: Build Windows Portableï¼ˆæ„å»º Windows ç»¿è‰²ç‰ˆï¼‰
    runs-on: windows-latest
    needs: [ get-version, build-jar-artifact ]

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          check-latest: false  # ç¦ç”¨æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬ï¼Œé¿å… GitHub API é€Ÿç‡é™åˆ¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ token æé«˜ API é€Ÿç‡é™åˆ¶

      - name: Download Fat JARï¼ˆä¸‹è½½è·¨å¹³å° Fat JARï¼‰
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»º Windows ç²¾ç®€ JREï¼‰
        shell: pwsh
        run: |
          $runtimeDir = "target\runtime"
          if (Test-Path $runtimeDir) { Remove-Item -Recurse -Force $runtimeDir }
          
          jlink `
            --add-modules $env:JLINK_MODULES `
            --strip-java-debug-attributes `
            --strip-native-commands `
            --strip-debug `
            --no-header-files `
            --no-man-pages `
            --compress=2 `
            --verbose `
            --output $runtimeDir
          
          # éªŒè¯ JRE å¤§å°
          $size = (Get-ChildItem -Path $runtimeDir -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "âœ… JRE åˆ›å»ºæˆåŠŸï¼Œå¤§å°: $([math]::Round($size, 2)) MB"

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $jarNameWithVersion = "easy-postman-$version.jar"
          $jarName = "easy-postman.jar"
          
          $distInputDir = "target\dist-input"
          if (Test-Path $distInputDir) { Remove-Item -Recurse -Force $distInputDir }
          New-Item -ItemType Directory -Path $distInputDir | Out-Null
          
          # é‡å‘½å JAR ä¸ºå›ºå®šåç§°ï¼ˆå»é™¤ç‰ˆæœ¬å·ï¼‰
          Copy-Item "target\$jarNameWithVersion" -Destination "$distInputDir\$jarName"

      - name: Create app-image with jpackageï¼ˆåˆ›å»ºåº”ç”¨é•œåƒï¼Œå…å®‰è£…ï¼‰
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $jarName = "easy-postman.jar"
          $appImageDir = "target\app-image"
          
          if (Test-Path $appImageDir) { Remove-Item -Recurse -Force $appImageDir }
          
          # è§£æé€šç”¨ Java é€‰é¡¹
          $javaOptsCommon = $env:JAVA_OPTIONS_COMMON -split '\|'
          # è§£æ Windows ç‰¹å®šé€‰é¡¹
          $javaOptsWindows = $env:JAVA_OPTIONS_WINDOWS -split '\|'
          
          # æ„å»º jpackage å‚æ•°åˆ—è¡¨
          $jpackageArgs = @(
            '--type', 'app-image',
            '--input', 'target\dist-input',
            '--main-jar', $jarName,
            '--main-class', 'com.laker.postman.App',
            '--runtime-image', 'target\runtime',
            '--dest', 'target',
            '--icon', 'assets\win\EasyPostman.ico',
            '--name', 'EasyPostman',
            '--app-version', $version,
            '--vendor', 'Laker',
            '--copyright', 'Â© 2025 Laker'
          )
          
          # æ·»åŠ é€šç”¨ Java é€‰é¡¹
          foreach ($opt in $javaOptsCommon) {
            $jpackageArgs += '--java-options'
            $jpackageArgs += $opt
          }
          
          # æ·»åŠ  Windows ç‰¹å®šé€‰é¡¹
          foreach ($opt in $javaOptsWindows) {
            if ($opt -ne '') {
              $jpackageArgs += '--java-options'
              $jpackageArgs += $opt
            }
          }
          
          # æ‰§è¡Œ jpackage
          & jpackage @jpackageArgs

      - name: Package portable versionï¼ˆæ‰“åŒ…ç»¿è‰²ç‰ˆä¸º ZIPï¼‰
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $appImageDir = "target\EasyPostman"
          $zipName = "EasyPostman-$version-windows-x64-portable.zip"
          
          if (-not (Test-Path "dist")) { New-Item -ItemType Directory -Path "dist" | Out-Null }
          
          # åˆ›å»º .portable æ ‡è¯†æ–‡ä»¶ï¼Œç”¨äºè¿è¡Œæ—¶æ£€æµ‹ä¾¿æºç‰ˆ
          $portableMarker = Join-Path $appImageDir ".portable"
          "This is a portable version" | Out-File -FilePath $portableMarker -Encoding UTF8
          Write-Host "Created .portable marker file"
          
          # å‹ç¼©ä¸º ZIP
          Compress-Archive -Path $appImageDir -DestinationPath "dist\$zipName" -Force
          
          Write-Host "âœ… Created portable version: $zipName"

      - name: Upload as Artifactï¼ˆä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Windows-Portable
          path: dist/*-portable.zip
          retention-days: 7


  build-windows-exe:
    name: Build Windows EXE Installerï¼ˆæ„å»º Windows EXE å®‰è£…ç¨‹åºï¼‰
    runs-on: windows-latest
    needs: [ get-version, build-jar-artifact ]

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          check-latest: false  # ç¦ç”¨æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬ï¼Œé¿å… GitHub API é€Ÿç‡é™åˆ¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ token æé«˜ API é€Ÿç‡é™åˆ¶

      - name: Download Fat JARï¼ˆä¸‹è½½è·¨å¹³å° Fat JARï¼‰
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Install Inno Setupï¼ˆå®‰è£… Inno Setupï¼‰
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Installing Inno Setup..."
          choco install innosetup -y --no-progress
          
          # åˆ·æ–°ç¯å¢ƒå˜é‡
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          # éªŒè¯å®‰è£…
          $iscc = Get-Command iscc -ErrorAction SilentlyContinue
          if ($iscc) {
            Write-Host "âœ… Inno Setup installed: $($iscc.Source)"
            # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯ï¼ˆiscc ä¸å¸¦å‚æ•°ä¼šæ˜¾ç¤ºç‰ˆæœ¬å’Œå¸®åŠ©ï¼‰
            & iscc 2>&1 | Select-Object -First 5
          } else {
            Write-Error "âŒ Inno Setup installation failed"
            exit 1
          }

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»º Windows ç²¾ç®€ JREï¼‰
        shell: pwsh
        run: |
          $runtimeDir = "target\runtime"
          if (Test-Path $runtimeDir) { Remove-Item -Recurse -Force $runtimeDir }
          
          jlink `
            --add-modules $env:JLINK_MODULES `
            --strip-java-debug-attributes `
            --strip-native-commands `
            --strip-debug `
            --no-header-files `
            --no-man-pages `
            --compress=2 `
            --verbose `
            --output $runtimeDir
          
          # éªŒè¯ JRE å¤§å°
          $size = (Get-ChildItem -Path $runtimeDir -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "âœ… JRE åˆ›å»ºæˆåŠŸï¼Œå¤§å°: $([math]::Round($size, 2)) MB"

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $jarNameWithVersion = "easy-postman-$version.jar"
          $jarName = "easy-postman.jar"
          
          $distInputDir = "target\dist-input"
          if (Test-Path $distInputDir) { Remove-Item -Recurse -Force $distInputDir }
          New-Item -ItemType Directory -Path $distInputDir | Out-Null
          
          # é‡å‘½å JAR ä¸ºå›ºå®šåç§°ï¼ˆå»é™¤ç‰ˆæœ¬å·ï¼‰
          Copy-Item "target\$jarNameWithVersion" -Destination "$distInputDir\$jarName"

      - name: Create app-image with jpackageï¼ˆåˆ›å»ºåº”ç”¨é•œåƒï¼‰
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $jarName = "easy-postman.jar"
          
          # è§£æé€šç”¨ Java é€‰é¡¹
          $javaOptsCommon = $env:JAVA_OPTIONS_COMMON -split '\|'
          # è§£æ Windows ç‰¹å®šé€‰é¡¹
          $javaOptsWindows = $env:JAVA_OPTIONS_WINDOWS -split '\|'
          
          # æ„å»º jpackage å‚æ•°åˆ—è¡¨
          $jpackageArgs = @(
            '--type', 'app-image',
            '--input', 'target\dist-input',
            '--main-jar', $jarName,
            '--main-class', 'com.laker.postman.App',
            '--runtime-image', 'target\runtime',
            '--dest', 'target',
            '--icon', 'assets\win\EasyPostman.ico',
            '--name', 'EasyPostman',
            '--app-version', $version,
            '--vendor', 'Laker',
            '--copyright', 'Â© 2025 Laker'
          )
          
          # æ·»åŠ é€šç”¨ Java é€‰é¡¹
          foreach ($opt in $javaOptsCommon) {
            $jpackageArgs += '--java-options'
            $jpackageArgs += $opt
          }
          
          # æ·»åŠ  Windows ç‰¹å®šé€‰é¡¹
          foreach ($opt in $javaOptsWindows) {
            if ($opt -ne '') {
              $jpackageArgs += '--java-options'
              $jpackageArgs += $opt
            }
          }
          
          # æ‰§è¡Œ jpackage
          & jpackage @jpackageArgs
          
          Write-Host "âœ… App image created at: target\EasyPostman"

      - name: Create EXE with Inno Setupï¼ˆä½¿ç”¨ Inno Setup åˆ›å»º EXE å®‰è£…ç¨‹åºï¼‰
        shell: pwsh
        run: |
          $version = "${{ needs.get-version.outputs.version }}"
          $issScript = "build\easy-postman.iss"
          $arch = "x64"  # å½“å‰æ„å»ºä¸º x64ï¼Œæœªæ¥å¯æ‰©å±•ä¸º arm64
          
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          if (-not (Test-Path "dist")) { 
            New-Item -ItemType Directory -Path "dist" | Out-Null 
          }
          
          Write-Host "ğŸ”¨ Building EXE installer with Inno Setup..."
          Write-Host "   Version: $version"
          Write-Host "   Architecture: $arch"
          Write-Host "   Script: $issScript"
          Write-Host "   Source: target\EasyPostman"
          
          # éªŒè¯æºç›®å½•å­˜åœ¨
          if (-not (Test-Path "target\EasyPostman")) {
            Write-Error "âŒ Source directory not found: target\EasyPostman"
            exit 1
          }
          
          # è¿è¡Œ Inno Setup ç¼–è¯‘å™¨
          # æ³¨æ„ï¼šè·¯å¾„ç›¸å¯¹äº ISS è„šæœ¬ä½ç½®ï¼ˆbuild ç›®å½•ï¼‰ï¼Œæ‰€ä»¥éœ€è¦ ..\
          & iscc `
            "/DMyAppVersion=$version" `
            "/DMyAppSourceDir=..\target\EasyPostman" `
            "/DMyOutputDir=..\dist" `
            "/DMyArch=$arch" `
            $issScript
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "âŒ Inno Setup compilation failed with exit code: $LASTEXITCODE"
            exit 1
          }
          
          # éªŒè¯ EXE æ–‡ä»¶
          $expectedExeName = "EasyPostman-$version-windows-$arch.exe"
          $exeFile = Get-Item "dist\$expectedExeName" -ErrorAction SilentlyContinue
          
          if ($exeFile) {
            Write-Host "âœ… EXE installer created successfully!"
            Write-Host "   File: $($exeFile.Name)"
            Write-Host "   Size: $([math]::Round($exeFile.Length / 1MB, 2)) MB"
            Write-Host "   Path: $($exeFile.FullName)"
          } else {
            Write-Error "âŒ Expected EXE file not found: $expectedExeName"
            Write-Host "Files in dist folder:"
            Get-ChildItem "dist" | ForEach-Object { Write-Host "  - $($_.Name)" }
            exit 1
          }

      - name: Upload as Artifactï¼ˆä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Windows-EXE
          path: dist/*.exe
          retention-days: 7

  build-macos-intel:
    name: Build macOS Intel DMGï¼ˆæ„å»º macOS Intel ç‰ˆå®‰è£…åŒ…ï¼‰
    runs-on: macos-15-intel  # Intel x86_64
    needs: [ get-version, build-jar-artifact ]

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          check-latest: false  # ç¦ç”¨æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬ï¼Œé¿å… GitHub API é€Ÿç‡é™åˆ¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ token æé«˜ API é€Ÿç‡é™åˆ¶

      - name: Download Fat JARï¼ˆä¸‹è½½è·¨å¹³å° Fat JARï¼‰
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»º macOS Intel ç²¾ç®€ JREï¼‰
        run: |
          rm -rf target/runtime
          # åˆ›å»º macOS Intel å¹³å°çš„ JRE
          jlink \
            --add-modules ${{ env.JLINK_MODULES }} \
            --strip-java-debug-attributes \
            --strip-native-commands \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --verbose \
            --output target/runtime
          
          # éªŒè¯ JRE å¤§å°
          echo "âœ… JRE åˆ›å»ºæˆåŠŸï¼Œå¤§å°: $(du -sh target/runtime | cut -f1)"

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME_WITH_VERSION="easy-postman-$VERSION.jar"
          JAR_NAME="easy-postman.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          # é‡å‘½å JAR ä¸ºå›ºå®šåç§°ï¼ˆå»é™¤ç‰ˆæœ¬å·ï¼‰
          cp target/$JAR_NAME_WITH_VERSION target/dist-input/$JAR_NAME

      - name: Create DMG with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º DMG é•œåƒï¼‰
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME="easy-postman.jar"
          
          mkdir -p dist
          
          # è§£æé€šç”¨ Java é€‰é¡¹
          IFS='|' read -ra JAVA_OPTS_COMMON <<< "${{ env.JAVA_OPTIONS_COMMON }}"
          # è§£æ macOS ç‰¹å®šé€‰é¡¹
          IFS='|' read -ra JAVA_OPTS_MACOS <<< "${{ env.JAVA_OPTIONS_MACOS }}"
          
          # æ„å»º jpackage å‚æ•°æ•°ç»„
          JPACKAGE_ARGS=(
            --input target/dist-input
            --main-jar "$JAR_NAME"
            --main-class com.laker.postman.App
            --runtime-image target/runtime
            --type dmg
            --name "EasyPostman"
            --app-version "$VERSION"
            --dest dist
            --icon assets/mac/EasyPostman.icns
            --vendor "Laker"
            --copyright "Â© 2025 Laker"
          )
          
          # æ·»åŠ é€šç”¨ Java é€‰é¡¹
          for opt in "${JAVA_OPTS_COMMON[@]}"; do
            JPACKAGE_ARGS+=(--java-options "$opt")
          done
          
          # æ·»åŠ  macOS ç‰¹å®šé€‰é¡¹
          for opt in "${JAVA_OPTS_MACOS[@]}"; do
            if [ -n "$opt" ]; then
              JPACKAGE_ARGS+=(--java-options "$opt")
            fi
          done
          
          # æ‰§è¡Œ jpackage
          jpackage "${JPACKAGE_ARGS[@]}"
          
          # é‡å‘½åä¸º Intel ç‰ˆæœ¬ï¼ˆä½¿ç”¨æ ‡å‡†æ¶æ„æ ‡è¯†ï¼‰
          mv dist/EasyPostman-$VERSION.dmg dist/EasyPostman-$VERSION-macos-x86_64.dmg
          echo "âœ… Created: EasyPostman-$VERSION-macos-x86_64.dmg"

      - name: Upload as Artifactï¼ˆä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-macOS-Intel-DMG
          path: dist/*-macos-x86_64.dmg
          retention-days: 7  # ä¿ç•™ 7 å¤©

  build-macos-arm:
    name: Build macOS Apple Silicon DMGï¼ˆæ„å»º macOS Apple Silicon ç‰ˆå®‰è£…åŒ…ï¼‰
    runs-on: macos-latest  # Apple Silicon (M1/M2/M3/M4)
    needs: [ get-version, build-jar-artifact ]

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          check-latest: false  # ç¦ç”¨æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬ï¼Œé¿å… GitHub API é€Ÿç‡é™åˆ¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ token æé«˜ API é€Ÿç‡é™åˆ¶

      - name: Download Fat JARï¼ˆä¸‹è½½è·¨å¹³å° Fat JARï¼‰
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»º macOS ARM ç²¾ç®€ JREï¼‰
        run: |
          rm -rf target/runtime
          # åˆ›å»º macOS ARM å¹³å°çš„ JRE
          jlink \
            --add-modules ${{ env.JLINK_MODULES }} \
            --strip-java-debug-attributes \
            --strip-native-commands \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --verbose \
            --output target/runtime
          
          # éªŒè¯ JRE å¤§å°
          echo "âœ… JRE åˆ›å»ºæˆåŠŸï¼Œå¤§å°: $(du -sh target/runtime | cut -f1)"

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME_WITH_VERSION="easy-postman-$VERSION.jar"
          JAR_NAME="easy-postman.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          # é‡å‘½å JAR ä¸ºå›ºå®šåç§°ï¼ˆå»é™¤ç‰ˆæœ¬å·ï¼‰
          cp target/$JAR_NAME_WITH_VERSION target/dist-input/$JAR_NAME

      - name: Create DMG with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º DMG é•œåƒï¼‰
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME="easy-postman.jar"
          
          mkdir -p dist
          
          # è§£æé€šç”¨ Java é€‰é¡¹
          IFS='|' read -ra JAVA_OPTS_COMMON <<< "${{ env.JAVA_OPTIONS_COMMON }}"
          # è§£æ macOS ç‰¹å®šé€‰é¡¹
          IFS='|' read -ra JAVA_OPTS_MACOS <<< "${{ env.JAVA_OPTIONS_MACOS }}"
          
          # æ„å»º jpackage å‚æ•°æ•°ç»„
          JPACKAGE_ARGS=(
            --input target/dist-input
            --main-jar "$JAR_NAME"
            --main-class com.laker.postman.App
            --runtime-image target/runtime
            --type dmg
            --name "EasyPostman"
            --app-version "$VERSION"
            --dest dist
            --icon assets/mac/EasyPostman.icns
            --vendor "Laker"
            --copyright "Â© 2025 Laker"
          )
          
          # æ·»åŠ é€šç”¨ Java é€‰é¡¹
          for opt in "${JAVA_OPTS_COMMON[@]}"; do
            JPACKAGE_ARGS+=(--java-options "$opt")
          done
          
          # æ·»åŠ  macOS ç‰¹å®šé€‰é¡¹
          for opt in "${JAVA_OPTS_MACOS[@]}"; do
            if [ -n "$opt" ]; then
              JPACKAGE_ARGS+=(--java-options "$opt")
            fi
          done
          
          # æ‰§è¡Œ jpackage
          jpackage "${JPACKAGE_ARGS[@]}"
          
          # é‡å‘½åä¸º ARM ç‰ˆæœ¬ï¼ˆä½¿ç”¨æ ‡å‡†æ¶æ„æ ‡è¯†ï¼‰
          mv dist/EasyPostman-$VERSION.dmg dist/EasyPostman-$VERSION-macos-arm64.dmg
          echo "âœ… Created: EasyPostman-$VERSION-macos-arm64.dmg"

      - name: Upload as Artifactï¼ˆä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-macOS-ARM-DMG
          path: dist/*-macos-arm64.dmg
          retention-days: 7  # ä¿ç•™ 7 å¤©

  build-jar:
    name: Build Standalone JARï¼ˆæ„å»ºç‹¬ç«‹ JAR åŒ…ï¼‰
    runs-on: ubuntu-latest
    needs: [ get-version, build-jar-artifact ]

    steps:
      - name: Download JAR artifactï¼ˆä¸‹è½½å·²æ„å»ºçš„ JARï¼‰
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: dist

      - name: Upload as Artifactï¼ˆä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Standalone-JAR
          path: dist/*.jar
          retention-days: 7



  build-ubuntu:
    name: Build Ubuntu DEBï¼ˆæ„å»º Ubuntu å®‰è£…åŒ…ï¼‰
    runs-on: ubuntu-22.04
    needs: [ get-version, build-jar-artifact ]

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Setup Javaï¼ˆé…ç½® Javaï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          check-latest: false  # ç¦ç”¨æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬ï¼Œé¿å… GitHub API é€Ÿç‡é™åˆ¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ token æé«˜ API é€Ÿç‡é™åˆ¶

      - name: Download Fat JARï¼ˆä¸‹è½½è·¨å¹³å° Fat JARï¼‰
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target

      - name: Install dependenciesï¼ˆå®‰è£…ç³»ç»Ÿä¾èµ–ï¼‰
        run: |
          sudo apt-get update
          # å®‰è£… GTK3ã€WebKit å’Œæ‰“åŒ…å·¥å…·
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev binutils

      - name: Create runtime with jlinkï¼ˆä½¿ç”¨ jlink åˆ›å»º Linux ç²¾ç®€ JREï¼‰
        run: |
          rm -rf target/runtime
          # åˆ›å»º Linux å¹³å°çš„ JRE
          jlink \
            --add-modules ${{ env.JLINK_MODULES }} \
            --strip-debug \
            --no-header-files \
            --no-man-pages \
            --compress=2 \
            --output target/runtime

      - name: Prepare dist-inputï¼ˆå‡†å¤‡æ‰“åŒ…è¾“å…¥ç›®å½•ï¼‰
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME_WITH_VERSION="easy-postman-$VERSION.jar"
          JAR_NAME="easy-postman.jar"
          
          rm -rf target/dist-input
          mkdir -p target/dist-input
          # é‡å‘½å JAR ä¸ºå›ºå®šåç§°ï¼ˆå»é™¤ç‰ˆæœ¬å·ï¼‰
          cp target/$JAR_NAME_WITH_VERSION target/dist-input/$JAR_NAME

      - name: Create DEB with jpackageï¼ˆä½¿ç”¨ jpackage åˆ›å»º DEB å®‰è£…åŒ…ï¼‰
        run: |
          VERSION="${{ needs.get-version.outputs.version }}"
          JAR_NAME="easy-postman.jar"
          
          mkdir -p dist
          
          # è§£æé€šç”¨ Java é€‰é¡¹
          IFS='|' read -ra JAVA_OPTS_COMMON <<< "${{ env.JAVA_OPTIONS_COMMON }}"
          # è§£æ Linux ç‰¹å®šé€‰é¡¹
          IFS='|' read -ra JAVA_OPTS_LINUX <<< "${{ env.JAVA_OPTIONS_LINUX }}"
          
          # æ„å»º jpackage å‚æ•°æ•°ç»„
          JPACKAGE_ARGS=(
            --input target/dist-input
            --main-jar "$JAR_NAME"
            --main-class com.laker.postman.App
            --runtime-image target/runtime
            --type deb
            --name "EasyPostman"
            --app-version "$VERSION"
            --dest dist
            --vendor "Laker"
            --copyright "Â© 2025 Laker"
            --description "A modern API testing tool similar to Postman"
            --linux-shortcut
            --linux-menu-group "Development"
            --linux-app-category "Development"
          )
          
          # æ·»åŠ é€šç”¨ Java é€‰é¡¹
          for opt in "${JAVA_OPTS_COMMON[@]}"; do
            JPACKAGE_ARGS+=(--java-options "$opt")
          done
          
          # æ·»åŠ  Linux ç‰¹å®šé€‰é¡¹
          for opt in "${JAVA_OPTS_LINUX[@]}"; do
            if [ -n "$opt" ]; then
              JPACKAGE_ARGS+=(--java-options "$opt")
            fi
          done
          
          # æ‰§è¡Œ jpackage
          jpackage "${JPACKAGE_ARGS[@]}"

      - name: Upload as Artifactï¼ˆä¸Šä¼ ä¸ºæ„å»ºäº§ç‰©ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: EasyPostman-Ubuntu-DEB
          path: dist/*.deb
          retention-days: 7  # ä¿ç•™ 7 å¤©

  # å‘å¸ƒåˆ° GitHub Release
  publish-to-release:
    name: Publish to GitHub Releaseï¼ˆå‘å¸ƒåˆ° GitHub Releaseï¼‰
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: [ get-version, build-windows-portable, build-windows-exe, build-macos-intel, build-macos-arm, build-ubuntu, build-jar ]
    runs-on: ubuntu-latest

    steps:
      - name: Download All Artifactsï¼ˆä¸‹è½½æ‰€æœ‰äº§ç‰©ï¼‰
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Organize Release Filesï¼ˆæ•´ç†å‘å¸ƒæ–‡ä»¶ï¼‰
        run: |
          mkdir -p release-files
          find all-artifacts -type f \( -name "*.zip" -o -name "*.exe" -o -name "*.dmg" -o -name "*.deb" -o -name "*.jar" \) -exec cp {} release-files/ \;
          echo "ğŸ“¦ Files prepared for release:"
          ls -lah release-files/

      - name: Create Release and Upload Assetsï¼ˆåˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶ï¼‰
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "auto-build-${{ github.run_number }}"
          name: "Auto Build #${{ github.run_number }} - v${{ needs.get-version.outputs.version }}"
          body: |
            ğŸš€ EasyPostman Auto Build Release

            ## ğŸ“¥ Download Packages

            Platform-specific installers are available below:

            ### Windows
            - ğŸŸ¢ **EasyPostman-*-windows-x64-portable.zip** - Portable version (recommended)
            - ğŸ’¾ **EasyPostman-*-windows-x64.exe** - Installer version

            ### macOS
            - ğŸ **EasyPostman-*-macos-x86_64.dmg** - Intel version
            - ğŸ **EasyPostman-*-macos-arm64.dmg** - Apple Silicon (M1/M2/M3/M4)

            ### Linux
            - ğŸ§ **EasyPostman-*-amd64.deb** - Ubuntu/Debian package

            ### Cross-Platform
            - ğŸ“„ **easy-postman-*.jar** - Standalone JAR (requires Java 17+)

            **Build Time**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          files: release-files/*
          draft: false
          prerelease: false
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # åŒæ­¥åˆ°ç äº‘ï¼ˆGiteeï¼‰
  sync-to-gitee:
    name: Sync to Gitee Releaseï¼ˆåŒæ­¥åˆ°ç äº‘å‘è¡Œç‰ˆï¼‰
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: [ get-version, publish-to-release ]
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkoutï¼ˆæ£€å‡ºä»£ç ï¼‰
        uses: actions/checkout@v4

      - name: Download All Artifactsï¼ˆä¸‹è½½æ‰€æœ‰äº§ç‰©ï¼‰
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Create Gitee Releaseï¼ˆåˆ›å»ºç äº‘å‘è¡Œç‰ˆï¼‰
        id: create_release
        run: |
          set -euo pipefail

          VERSION="${{ needs.get-version.outputs.version }}"
          RELEASE_TAG="auto-build-${{ github.run_number }}"
          RELEASE_NAME="Auto Build #${{ github.run_number }} - v${VERSION}"
          RELEASE_BODY=$(cat <<'EOF'
          ğŸš€ EasyPostman Auto Build Release

          ## ğŸ“¥ ä¸‹è½½å®‰è£…åŒ…

          å‚è§ä¸‹æ–¹é™„ä»¶ï¼ˆWindows/macOS/Linux/JARï¼‰
          EOF
          )

          echo "Creating Gitee release: $RELEASE_TAG"

          # ä½¿ç”¨ form-data æäº¤ï¼ŒåŒ…å«å¿…é¡»çš„ target_commitish å­—æ®µï¼ˆè¿™é‡Œä½¿ç”¨å½“å‰è¿è¡Œçš„ commit SHAï¼‰
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://gitee.com/api/v5/repos/ssff_admin/EasyPostman/releases" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "tag_name=${RELEASE_TAG}" \
            -F "name=${RELEASE_NAME}" \
            -F "body=${RELEASE_BODY}" \
            -F "prerelease=false" \
            -F "target_commitish=${{ github.sha }}" )
        
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            # æå– release id
            RELEASE_ID=$(echo "$BODY" | jq -r '.id // empty')
            if [ -z "$RELEASE_ID" ]; then
              echo "âŒ Created but could not extract release id. Full response:"
              echo "$BODY"
              exit 1
            fi
            echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
            echo "âœ… Gitee Release created with ID: $RELEASE_ID"
          else
            echo "âŒ Failed to create Gitee Release (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

      - name: Upload Files to Gitee Releaseï¼ˆä¸Šä¼ æ–‡ä»¶åˆ°ç äº‘ï¼‰
        if: steps.create_release.outputs.release_id != ''
        run: |
          RELEASE_ID="${{ steps.create_release.outputs.release_id }}"
          UPLOADED=0
          FAILED=0
          
          for file in gitee-files/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "ğŸ“¦ Uploading: $filename"
          
              for attempt in {1..3}; do
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
                  "https://gitee.com/api/v5/repos/ssff_admin/EasyPostman/releases/$RELEASE_ID/attach_files" \
                  -F "access_token=${{ secrets.GITEE_TOKEN }}" \
                  -F "file=@$file")
          
                if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                  echo "âœ… $filename uploaded (HTTP $HTTP_CODE)"
                  ((UPLOADED++))
                  break
                else
                  echo "âš ï¸ Attempt $attempt/3 failed (HTTP $HTTP_CODE)"
                  if [ $attempt -lt 3 ]; then
                    sleep 5
                  else
                    ((FAILED++))
                  fi
                fi
              done
            fi
          done
          
          echo ""
          echo "ğŸ“Š Upload Summary:"
          echo "âœ… Successful: $UPLOADED"
          echo "âŒ Failed: $FAILED"

      - name: Print Release Infoï¼ˆæ˜¾ç¤ºå‘è¡Œç‰ˆä¿¡æ¯ï¼‰
        run: |
          echo "ğŸ‰ Release Sync Complete!"
          echo ""
          echo "ğŸ“ GitHub Release:"
          echo "https://github.com/winds91/EasyPostman/releases/tag/auto-build-${{ github.run_number }}"
          echo ""
          echo "ğŸ“ Gitee Release:"
          echo "https://gitee.com/ssff_admin/EasyPostman/releases/tag/auto-build-${{ github.run_number }}"
